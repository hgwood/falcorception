const _ = require("lodash")
const injectable = require("injectable")

module.exports = injectable({
  route: "apisById[{keys:ids}][{keys:props}]",
  get: function* (paths, apiRepository) {
    // potential performance improvement: streaming
    // potential performance improvement: use mongo id for selection
    const pathsByApi = yield apiRepository.find()
      .filter({id: {$in: paths.ids}})
      .sort({created: 1})
      .project(_(["id", ...paths.props]).map(prop => [prop, true]).fromPairs().value())
      .map(api => _.map(paths.props, prop => ({
        path: ["apisById", api.id, prop],
        value: api[prop],
      })))
      .toArray()
    return _.flatten(pathsByApi)
  },
  set: function* (jsonGraph, apiRepository) {
    const operations = _.map(jsonGraph.apisById, (api, id) => ({
      updateOne: {filter: {id}, update: {$set: api}},
    }))
    yield apiRepository.bulkWrite(operations)
    return {jsonGraph}
  },
})
