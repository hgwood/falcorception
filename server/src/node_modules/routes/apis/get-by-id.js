const _ = require("lodash")
const injectable = require("injectable")

module.exports = injectable({
  route: "apisById[{keys:ids}][{keys:props}]",
  get: function* (paths, apiRepository) {
    // TODO: stream this
    const pathsByApi = yield apiRepository.find()
      .filter({id: {$in: paths.ids}})
      .sort({created: 1})
      .project(_(["id", ...paths.props]).map(prop => [prop, true]).fromPairs().value())
      .map(api => _.map(paths.props, prop => ({
        path: ["apisById", api.id, prop],
        value: api[prop],
      })))
      .toArray()
    return _.flatten(pathsByApi)
  },
})
