const injectable = require("injectable")
const shortid = require("shortid")

module.exports = injectable({
  route: "apis.create",
  call: function* (path, [name], refPaths, thisPaths, apiRepository, apiRunner) {
    const id = shortid.generate()
    const created = new Date().toISOString()
    const url = `/${id}`
    const api = {id, name, created, url, routes: {length: 0}}
    yield apiRepository.insertOne(api)
    apiRunner(api)
    // potential future performance problem
    const newCount = yield apiRepository.find().count()
    const ref = {$type: "ref", value: ["apisById", id]}
    return [
      {path: ["apis", newCount - 1], value: ref},
      {path: ["apis", "lastAdded"], value: ref},
      {path: ["apis", "length"], value: newCount},
    ]
  },
})
