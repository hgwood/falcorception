const _ = require("lodash")
const co = require("co")
const injectable = require("injectable")
const rx = require("rx")

module.exports = injectable({
  route: "apis[{integers:indices}]",
  get: function(paths, apiRepository) {
    // TODO: stream this
    const ids = apiRepository.find()
      .sort({created: 1})
      .project({"id": true})
      .map(api => api.id)
      .toArray().then(ids => {
        return _(ids)
          .pickBy((id, index) => _.includes(paths.indices, Number(index)))
          .map((id, index) => ({
            path: ["apis", index],
            value: {$type: "ref", value: ["apisById", id]},
          }))
          .value()

      })
    return rx.Observable.fromPromise(ids)
  },
})
