const _ = require("lodash")
const co = require("co")
const injectable = require("injectable")

module.exports = injectable({
  route: "apis[{integers:indices}]",
  get: co.wrap(function* (paths, apiRepository) {
    // TODO: stream this
    const ids = yield apiRepository.find()
      .sort({created: 1})
      .project({"id": true})
      .map(api => api.id)
      .toArray()
    return _(ids)
      .pickBy((id, index) => _.includes(paths.indices, index))
      .map((id, index) => ({
        path: ["apis", index],
        value: {$type: "ref", value: ["apisById", id]},
      }))
      .value()
  }),
})
