const _ = require("lodash")
const co = require("co")
const rx = require("rx")

module.exports = route => (...dependencies) => {
  const appendDependencies = method => (...args) => rx.Observable.fromPromise(co(function*() {
    return method(...args, ...yield Promise.all(dependencies))
  })).concatAll()
  return _.cloneDeepWith(route, (value, key) => {
    if (_.includes(["get", "set", "call"], key)) return appendDependencies(value)
  })
}
