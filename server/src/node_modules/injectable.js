const _ = require("lodash")
const co = require("co")

module.exports = route => (...dependencies) => {
  const appendDependencies = method => co.wrap(function* (...args) {
    return co.wrap(method)(...args, ...yield Promise.all(dependencies))
  })
  return _.cloneDeepWith(route, (value, key) => {
    if (_.includes(["get", "set", "call"], key)) return appendDependencies(value)
  })
}
