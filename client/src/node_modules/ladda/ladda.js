const ladda = require("Ladda")

module.exports = angular.module("falcorception.ladda", []).directive("ladda", () => ({
  restrict: "A",
  scope: {
    ladda: "&",
  },
  compile(templateElement) {
    templateElement.addClass("ladda-button")
    templateElement.attr("data-style", "zoom-in")
    const content = templateElement.html()
    templateElement.empty()
    templateElement.append(`<span class="ladda-label">${content}</span>`)
    return (scope, instanceElement) => {
      instanceElement.on("click", () => {
        const result = scope.ladda()
        if (!result.then) return
        const laddaEffect = ladda.create(instanceElement[0])
        laddaEffect.start()
        const stop = () => laddaEffect.stop()
        result
          .then(stop)
          .catch(err => {
            stop()
            throw err
          })
      })
    }
  },
}))
